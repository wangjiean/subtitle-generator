<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘å­—å¹•æå– & AI æ€»ç»“</title>
    <link rel="icon" href="/favicon.ico" type="image/svg+xml">
    <style>
        /* â”€â”€ åŸºç¡€ â”€â”€ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            /* é»˜è®¤ï¼šå¼€å¿ƒæ˜äº®ï¼ˆWarm Happyï¼‰ */
            --bg: #fff7ed;
            --surface: #ffffff;
            --surface2: #fff1e6;
            --accent: #fb7185;
            --accent2: #22c55e;
            --text: #1f2937;
            --text2: #6b7280;
            --border: #fed7aa;
            --success: #16a34a;
            --error: #ef4444;
            --warn: #f59e0b;
            --text-strong: #111827;
        }

        /* å¤œç©ºï¼ˆåŸæ¥çš„è“ç´«ç§‘å¹»é£ï¼‰ */
        :root[data-theme="night"] {
            --bg: #0f0f0f;
            --surface: #1a1a2e;
            --surface2: #16213e;
            --accent: #7c3aed;
            --accent2: #a78bfa;
            --text: #e2e8f0;
            --text2: #94a3b8;
            --border: #2d2d44;
            --success: #10b981;
            --error: #ef4444;
            --warn: #f59e0b;
            --text-strong: #ffffff;
        }

        /* ç³–æœï¼ˆæ›´æ´»æ³¼çš„æµ…è‰²ä¸»é¢˜ï¼‰ */
        :root[data-theme="candy"] {
            --bg: #fdf2f8;
            --surface: #ffffff;
            --surface2: #fff7fb;
            --accent: #a78bfa;
            --accent2: #fb7185;
            --text: #1f2937;
            --text2: #6b7280;
            --border: #fbcfe8;
            --success: #22c55e;
            --error: #ef4444;
            --warn: #f59e0b;
            --text-strong: #111827;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Noto Sans SC', sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        /* â”€â”€ é¡¶æ  â”€â”€ */
        .topbar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            height: 64px;
        }
        .topbar .logo {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            white-space: nowrap;
        }
        .url-input-wrap {
            flex: 1;
            display: flex;
            gap: 8px;
        }
        .url-input-wrap input {
            flex: 1;
            padding: 10px 16px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            outline: none;
            transition: border-color .2s;
        }
        .url-input-wrap input:focus { border-color: var(--accent); }
        .url-input-wrap input::placeholder { color: var(--text2); }
        .btn-primary {
            padding: 10px 24px;
            background: linear-gradient(135deg, var(--accent), #6d28d9);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity .2s, transform .1s;
            white-space: nowrap;
        }
        .btn-primary:hover { opacity: .9; }
        .btn-primary:active { transform: scale(.97); }
        .btn-primary:disabled {
            opacity: .5;
            cursor: not-allowed;
        }

        .theme-select {
            padding: 9px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 13px;
            outline: none;
            cursor: pointer;
        }
        .theme-select:focus { border-color: var(--accent); }
        .layout-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-layout {
            padding: 8px 10px;
            border-radius: 9px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text2);
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
        }
        .btn-layout:hover {
            border-color: var(--accent);
            color: var(--text);
        }
        .btn-layout.active {
            border-color: var(--accent);
            color: var(--text);
            background: color-mix(in srgb, var(--accent) 12%, transparent);
        }

        /* â”€â”€ çŠ¶æ€æ¡ â”€â”€ */
        .status-bar {
            padding: 8px 24px;
            background: var(--surface2);
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            color: var(--text2);
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 36px;
        }
        .status-bar .spinner {
            width: 14px; height: 14px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin .6s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .status-bar.success { color: var(--success); }
        .status-bar.error { color: var(--error); }
        .subtitle-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-official { background: #065f46; color: #6ee7b7; }
        .badge-auto { background: #713f12; color: #fde047; }
        .badge-whisper { background: #312e81; color: #a5b4fc; }

        /* â”€â”€ ä¸»ä½“åŒæ  â”€â”€ */
        .main {
            display: flex;
            height: calc(100vh - 64px - 36px);
        }
        .main-col { min-width: 0; }
        #sidebarCol {
            flex: 0 0 300px;
            width: 300px;
        }
        #centerCol {
            flex: 1 1 auto;
            min-width: 320px;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        #chatCol {
            flex: 0 0 420px;
            width: 420px;
        }
        .main-col.hidden { display: none !important; }
        .col-splitter {
            flex: 0 0 8px;
            width: 8px;
            cursor: col-resize;
            position: relative;
            user-select: none;
        }
        .col-splitter::before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 3px;
            width: 2px;
            background: var(--border);
            transition: background .2s;
        }
        .col-splitter:hover::before { background: var(--accent); }
        .col-splitter.hidden { display: none !important; }
        .col-splitter.locked {
            cursor: not-allowed;
            opacity: .45;
        }

        /* â”€â”€ é¡¹ç›®ä¾§è¾¹æ  â”€â”€ */
        .sidebar {
            width: 300px;
            min-width: 260px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 14px 14px 10px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        .sidebar-title {
            font-weight: 700;
            font-size: 13px;
            color: var(--text);
        }
        .sidebar-actions {
            display: flex;
            gap: 8px;
        }
        .btn-mini {
            padding: 7px 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text2);
            font-size: 12px;
            cursor: pointer;
            transition: border-color .2s, color .2s, opacity .2s;
            white-space: nowrap;
        }
        .btn-mini:hover {
            border-color: var(--accent);
            color: var(--text);
        }

        /* æ ‡ç­¾ç­›é€‰æ  */
        .tag-filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 8px 10px;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }
        .tag-chip {
            font-size: 13px;
            padding: 4px 12px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text2);
            cursor: pointer;
            transition: all .25s;
            white-space: nowrap;
            user-select: none;
            display: inline-flex;
            align-items: center;
            gap: 0;
        }
        .tag-chip:hover {
            border-color: var(--accent);
            color: var(--text);
            gap: 4px;
        }
        .tag-chip.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        .tag-chip-add {
            font-size: 13px;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px dashed var(--border);
            background: transparent;
            color: var(--text2);
            cursor: pointer;
            transition: all .2s;
        }
        .tag-chip-add:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        .tag-count {
            display: inline-block;
            background: rgba(128,128,128,.18);
            color: var(--text2);
            font-size: 10px;
            min-width: 16px;
            text-align: center;
            padding: 0 4px;
            border-radius: 8px;
            line-height: 16px;
            margin-left: 2px;
            font-weight: 600;
        }
        .tag-chip.active .tag-count {
            background: rgba(255,255,255,.25);
            color: inherit;
        }
        .project-thumb {
            width: 80px;
            height: 52px;
            border-radius: 6px;
            object-fit: cover;
            flex-shrink: 0;
            background: var(--border);
        }
        .tag-chip .tag-del {
            font-size: 11px;
            width: 0;
            opacity: 0;
            overflow: hidden;
            transition: width .2s, opacity .2s;
            cursor: pointer;
            flex-shrink: 0;
        }
        .tag-chip:hover .tag-del {
            width: 14px;
            opacity: .7;
        }
        .tag-chip .tag-del:hover {
            opacity: 1;
            color: var(--error);
        }
        /* é¡¹ç›®å¡ç‰‡ä¸Šçš„æ ‡ç­¾å°æ ‡ */
        .project-tag {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 999px;
            background: color-mix(in srgb, var(--accent) 15%, transparent);
            color: var(--accent);
            white-space: nowrap;
        }
        /* æ—¥æœŸåˆ†ç»„æ ‡é¢˜ */
        .date-group-header {
            font-size: 11px;
            color: var(--text2);
            padding: 6px 4px 2px;
            font-weight: 600;
            letter-spacing: 0.5px;
            user-select: none;
        }
        /* æ”¶è—æŒ‰é’® */
        .project-fav {
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            padding: 0 2px;
            opacity: .35;
            transition: opacity .2s, transform .15s;
        }
        .project-fav:hover {
            opacity: .8;
            transform: scale(1.2);
        }
        .project-fav.is-fav {
            opacity: 1;
            color: #d4a017;
            font-size: 15px;
        }
        /* å¯ç¼–è¾‘æ ‡é¢˜ */
        .video-title[contenteditable="true"] {
            outline: none;
            border-bottom: 1px dashed var(--accent);
            cursor: text;
            min-width: 100px;
        }
        .video-title[contenteditable="true"]:focus {
            border-bottom-color: var(--accent2);
        }
        .title-edit-hint {
            font-size: 10px;
            color: var(--text2);
            margin-left: 6px;
            opacity: 0;
            transition: opacity .2s;
        }
        .video-title:hover + .title-edit-hint,
        .video-title:focus + .title-edit-hint {
            opacity: 1;
        }
        /* é¡¹ç›®è¯¦æƒ…ä¸­çš„æ ‡ç­¾é€‰æ‹©å™¨ */
        .tag-selector {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
        }
        .tag-selector select {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            cursor: pointer;
        }

        .project-list {
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .project-list::-webkit-scrollbar { width: 6px; }
        .project-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .project-item {
            border: 1.5px solid color-mix(in srgb, var(--border) 80%, var(--text2));
            background: var(--surface);
            border-radius: 10px;
            padding: 10px 10px;
            cursor: pointer;
            transition: border-color .2s, transform .05s, background .2s;
        }
        .project-item:hover {
            border-color: var(--accent);
            background: var(--surface2);
        }
        .project-item:active { transform: scale(.99); }
        .project-item.active {
            border-color: var(--accent);
            background: var(--surface2);
        }
        .project-row {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 10px;
        }
        .project-name {
            font-size: 13px;
            font-weight: 650;
            color: var(--text);
            line-height: 1.3;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .project-meta {
            margin-top: 6px;
            font-size: 11px;
            color: var(--text2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        .project-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 3px;
            flex-shrink: 0;
        }
        .project-right-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .pill {
            font-size: 10px;
            padding: 2px 7px;
            border-radius: 999px;
            border: 1px solid var(--border);
            color: var(--text2);
            white-space: nowrap;
        }
        .pill-ok { border-color: rgba(16,185,129,.4); color: var(--success); }
        .pill-w { border-color: rgba(124,58,237,.3); color: var(--accent); }
        .pill-a { border-color: rgba(245,158,11,.4); color: var(--warn); }
        .project-del {
            border: none;
            background: transparent;
            color: var(--text2);
            cursor: pointer;
            padding: 0 4px;
            font-size: 14px;
            opacity: .7;
        }
        .project-del:hover { opacity: 1; color: #fca5a5; }
        .project-empty {
            padding: 18px 12px;
            color: var(--text2);
            font-size: 12px;
            text-align: center;
            line-height: 1.6;
        }

        /* â”€â”€ å·¦ä¾§: æ€»ç»“åŒº â”€â”€ */
        .panel-left {
            flex: 1;
            overflow-y: auto;
            padding: 24px 32px;
            border-right: 1px solid var(--border);
        }
        .panel-left::-webkit-scrollbar { width: 6px; }
        .panel-left::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text2);
            text-align: center;
        }
        .empty-state .icon { font-size: 64px; margin-bottom: 16px; }
        .empty-state h2 { font-size: 20px; margin-bottom: 8px; color: var(--text); }
        .empty-state p { font-size: 14px; line-height: 1.6; }

        /* â”€â”€ è§†é¢‘ä¿¡æ¯å¡ç‰‡ â”€â”€ */
        .video-card {
            display: flex;
            gap: 14px;
            padding: 14px 16px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,.04);
            border-radius: 14px;
            margin-bottom: 14px;
            align-items: center;
        }
        .video-cover {
            width: 128px;
            height: 72px;
            border-radius: 10px;
            object-fit: cover;
            border: 1px solid var(--border);
            background: rgba(0,0,0,.1);
            flex-shrink: 0;
        }
        .video-info {
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .video-title {
            font-weight: 750;
            font-size: 14px;
            color: var(--text);
            line-height: 1.35;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .video-sub {
            font-size: 12px;
            color: var(--text2);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        .video-link {
            color: var(--accent2);
            text-decoration: none;
            border-bottom: 1px dashed color-mix(in srgb, var(--text2) 55%, transparent);
        }
        .video-link:hover { opacity: .9; }

        .summary-cover-wrap {
            margin: 0 0 14px;
            border: 1px solid var(--border);
            border-radius: 14px;
            overflow: hidden;
            background: rgba(0,0,0,.04);
        }
        .summary-cover-img {
            width: 100%;
            max-height: 360px;
            object-fit: cover;
            display: block;
        }

        /* Markdown æ¸²æŸ“æ ·å¼ */
        .markdown-body { line-height: 1.8; }
        .markdown-body h1 {
            font-size: 26px; font-weight: 700;
            margin: 0 0 16px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent);
        }
        .markdown-body h2 {
            font-size: 20px; font-weight: 600;
            margin: 28px 0 12px;
            color: var(--accent2);
        }
        .markdown-body h3 {
            font-size: 16px; font-weight: 600;
            margin: 20px 0 8px;
        }
        .markdown-body p { margin: 8px 0; }
        .markdown-body ul, .markdown-body ol {
            margin: 8px 0; padding-left: 24px;
        }
        .markdown-body li { margin: 4px 0; }
        .markdown-body strong { color: var(--text-strong); }
        .markdown-body blockquote {
            margin: 12px 0;
            padding: 8px 16px;
            border-left: 3px solid var(--accent);
            background: color-mix(in srgb, var(--accent) 12%, transparent);
            border-radius: 0 6px 6px 0;
        }
        .markdown-body code {
            background: color-mix(in srgb, var(--accent) 16%, transparent);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
        }
        .markdown-body hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 20px 0;
        }

        /* â”€â”€ å·¦ä¾§ Tab åˆ‡æ¢ â”€â”€ */
        .tab-bar {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
            padding: 0 24px;
            gap: 0;
            flex-shrink: 0;
        }
        .tab-btn {
            padding: 10px 20px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text2);
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: color .2s, border-color .2s;
            white-space: nowrap;
        }
        .tab-btn:hover { color: var(--text); }
        .tab-btn.active {
            color: var(--accent2);
            border-bottom-color: var(--accent);
        }
        .tab-badge {
            display: inline-block;
            background: var(--accent);
            color: #fff;
            font-size: 10px;
            padding: 1px 6px;
            border-radius: 8px;
            margin-left: 6px;
            vertical-align: middle;
        }

        /* â”€â”€ å­—å¹•é¢æ¿ â”€â”€ */
        .transcript-panel {
            padding: 16px 24px;
            line-height: 1.7;
        }
        .transcript-line {
            display: flex;
            gap: 10px;
            padding: 6px 8px;
            border-radius: 6px;
            transition: background .15s;
            align-items: flex-start;
        }
        .transcript-line:hover {
            background: rgba(124, 58, 237, .08);
        }
        .ts-link {
            color: var(--accent2);
            font-family: 'SF Mono', 'Menlo', monospace;
            font-size: 12px;
            text-decoration: none;
            background: rgba(124, 58, 237, .12);
            padding: 2px 8px;
            border-radius: 4px;
            white-space: nowrap;
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 2px;
            transition: background .15s, color .15s;
        }
        .ts-link:hover {
            background: var(--accent);
            color: #fff;
        }
        .transcript-text {
            font-size: 14px;
            color: var(--text);
        }

        /* â”€â”€ è¿›åº¦æŒ‡ç¤º â”€â”€ */
        .progress-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--text2);
            gap: 12px;
        }
        .progress-wrap .spinner-lg {
            width: 32px; height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin .7s linear infinite;
        }
        .progress-info {
            font-size: 13px;
            text-align: center;
        }
        /* è½¬å½•è¿›åº¦æ¡ */
        .progress-bar-wrap {
            width: 280px;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        .progress-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent), var(--accent2));
            border-radius: 4px;
            transition: width .3s ease;
        }
        .progress-percent {
            font-size: 22px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .progress-detail {
            font-size: 11px;
            color: var(--text2);
            font-variant-numeric: tabular-nums;
        }

        /* â”€â”€ å³ä¾§: èŠå¤©åŒº â”€â”€ */
        .panel-right {
            width: 420px;
            min-width: 340px;
            display: flex;
            flex-direction: column;
            background: var(--surface);
        }
        .chat-header {
            padding: 14px 18px;
            font-weight: 600;
            font-size: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .chat-messages::-webkit-scrollbar { width: 5px; }
        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        .chat-empty {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text2);
            font-size: 13px;
            text-align: center;
            padding: 20px;
            line-height: 1.6;
        }
        .msg {
            max-width: 92%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.6;
            word-wrap: break-word;
        }
        .msg-user {
            align-self: flex-end;
            background: var(--accent);
            color: #fff;
            border-bottom-right-radius: 4px;
        }
        .msg-ai {
            align-self: flex-start;
            background: var(--surface2);
            color: var(--text);
            border-bottom-left-radius: 4px;
        }
        .msg-ai p { margin: 4px 0; }
        .msg-ai strong { color: var(--text-strong); }
        .msg-ai ul, .msg-ai ol { padding-left: 18px; margin: 4px 0; }
        .msg-ai code {
            background: rgba(124,58,237,.15);
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 12px;
        }
        .chat-input-wrap {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
        }
        .chat-input-wrap textarea {
            flex: 1;
            padding: 10px 14px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
            resize: none;
            outline: none;
            max-height: 120px;
            min-height: 42px;
            transition: border-color .2s;
        }
        .chat-input-wrap textarea:focus { border-color: var(--accent); }
        .chat-input-wrap textarea::placeholder { color: var(--text2); }
        .btn-send {
            padding: 10px 16px;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: opacity .2s;
            align-self: flex-end;
        }
        .btn-send:hover { opacity: .85; }
        .btn-send:disabled { opacity: .4; cursor: not-allowed; }
        .btn-voice {
            padding: 10px 12px;
            background: var(--surface);
            color: var(--text2);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: all .25s;
            align-self: flex-end;
            line-height: 1;
            position: relative;
        }
        .btn-voice:hover { border-color: var(--accent); color: var(--accent); }
        .btn-voice:disabled { opacity: .4; cursor: not-allowed; }
        .btn-voice.recording {
            background: color-mix(in srgb, #ef4444 12%, transparent);
            border-color: #ef4444;
            color: #ef4444;
            animation: voicePulse 1.2s ease-in-out infinite;
        }
        @keyframes voicePulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,.3); }
            50% { box-shadow: 0 0 0 6px rgba(239,68,68,0); }
        }

        /* â”€â”€ åˆ†éš”çº¿æ‹–æ‹½ï¼ˆå¯é€‰ï¼‰ â”€â”€ */
        .divider {
            width: 2px;
            cursor: col-resize;
            background: var(--border);
            transition: background .2s;
        }
        .divider:hover { background: var(--accent); }

        /* â”€â”€ å“åº”å¼ â”€â”€ */
        @media (max-width: 768px) {
            .main { flex-direction: column; }
            .col-splitter { display: none !important; }
            .panel-right { width: 100%; min-width: 0; height: 50%; }
            .panel-left { border-right: none; border-bottom: 1px solid var(--border); }
        }
    </style>
</head>
<body>
    <!-- é¡¶æ  -->
    <div class="topbar">
        <div class="logo">ğŸ“º ZimuAI</div>
        <div class="url-input-wrap">
            <input type="text" id="urlInput" 
                   placeholder="ç²˜è´´ Bilibili æˆ– YouTube è§†é¢‘é“¾æ¥..." 
                   autocomplete="off" spellcheck="false">
            <button class="btn-primary" id="btnProcess" onclick="startProcess()">
                ğŸš€ å¼€å§‹åˆ†æ
            </button>
        </div>

        <select class="theme-select" id="themeSelect" title="é€‰æ‹©ç•Œé¢é£æ ¼">
            <option value="happy">ğŸŒ å¼€å¿ƒ</option>
            <option value="candy">ğŸ¬ ç³–æœ</option>
            <option value="night">ğŸŒ™ å¤œç©º</option>
        </select>

        <div class="layout-controls">
            <button class="btn-layout" id="btnToggleSidebar" title="æ˜¾ç¤º/éšè—é¡¹ç›®æ ">ğŸ—‚ æ </button>
            <button class="btn-layout" id="btnLockSidebar" title="é”å®šé¡¹ç›®æ å®½åº¦">ğŸ”’ æ </button>
            <button class="btn-layout" id="btnLockChat" title="é”å®šèŠå¤©æ å®½åº¦">ğŸ”’ èŠ</button>
            <button class="btn-layout" id="btnToggleChat" title="æ˜¾ç¤º/éšè—èŠå¤©æ ">ğŸ’¬ æ </button>
        </div>
    </div>

    <!-- çŠ¶æ€æ¡ -->
    <div class="status-bar" id="statusBar">
        <span>å°±ç»ª â€” è¾“å…¥è§†é¢‘é“¾æ¥å¼€å§‹ä½¿ç”¨</span>
    </div>

    <!-- ä¸»ä½“ -->
    <div class="main">
        <!-- å·¦ä¾§ï¼šå†å²é¡¹ç›® -->
        <div class="sidebar main-col" id="sidebarCol">
            <div class="sidebar-header">
                <div class="sidebar-title">ğŸ—‚ å†å²é¡¹ç›®</div>
                <div class="sidebar-actions">
                    <button class="btn-mini" onclick="classifyAllProjects()" title="ä¸ºæ— æ ‡ç­¾é¡¹ç›®æ‰¹é‡åˆ†ç±»">ğŸ·ï¸ åˆ†ç±»</button>
                    <button class="btn-mini" onclick="refreshProjects()">â†» åˆ·æ–°</button>
                    <button class="btn-mini" onclick="newProjectView()">ï¼‹ æ–°å»º</button>
                </div>
            </div>
            <div class="tag-filter-bar" id="tagFilterBar">
                <!-- æ ‡ç­¾ç­›é€‰ chips ç”± JS æ¸²æŸ“ -->
            </div>
            <div class="project-list" id="projectList">
                <div class="project-empty">åŠ è½½ä¸­â€¦</div>
            </div>
        </div>

        <div class="col-splitter" id="splitterLeft" title="æ‹–æ‹½è°ƒæ•´é¡¹ç›®æ å®½åº¦"></div>

        <!-- å·¦ä¾§ï¼šæ€»ç»“ + å­—å¹• -->
        <div class="main-col" id="centerCol">
            <!-- Tab æ  -->
            <div class="tab-bar" id="tabBar" style="display:none;">
                <button class="tab-btn active" data-tab="summary" onclick="switchTab('summary')">ğŸ“‹ AI æ€»ç»“</button>
                <button class="tab-btn" data-tab="transcript" onclick="switchTab('transcript')">ğŸ“ åŸå§‹å­—å¹• <span class="tab-badge" id="segCountBadge" style="display:none;">0</span></button>
            </div>

            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="panel-left" id="panelLeft">
                <!-- è§†é¢‘å…ƒä¿¡æ¯ï¼ˆæœ‰ä»»åŠ¡/é¡¹ç›®æ—¶æ˜¾ç¤ºï¼‰ -->
                <div class="video-card" id="videoCard" style="display:none;">
                    <a id="videoLink" href="#" target="_blank" title="æ‰“å¼€è§†é¢‘">
                        <img id="videoCover" class="video-cover" alt="cover" />
                    </a>
                    <div class="video-info">
                        <div style="display:flex;align-items:center;">
                            <div class="video-title" id="videoTitle" contenteditable="false">è§†é¢‘æ ‡é¢˜</div>
                            <span class="title-edit-hint" id="titleEditHint">âœï¸ ç‚¹å‡»ç¼–è¾‘</span>
                        </div>
                        <div class="video-sub">
                            <a id="videoUploaderLink" href="#" target="_blank" style="display:flex;align-items:center;gap:6px;text-decoration:none;color:inherit;">
                                <img id="videoUploaderAvatar" style="width:24px;height:24px;border-radius:50%;object-fit:cover;display:none;" alt="" />
                                <span id="videoUploader">ğŸ‘¤</span>
                            </a>
                            <span id="videoDate">ğŸ—“</span>
                            <span class="tag-selector" id="tagSelectorWrap">
                                ğŸ·ï¸ <select id="tagSelect" onchange="onTagSelectChange(this.value)">
                                    <option value="">æœªåˆ†ç±»</option>
                                </select>
                            </span>
                            <a class="video-link" id="videoUrlText" href="#" target="_blank">æ‰“å¼€åŸè§†é¢‘</a>
                        </div>
                    </div>
                </div>
                <div class="empty-state" id="emptyState">
                    <div class="icon">ğŸ¬</div>
                    <h2>è§†é¢‘å†…å®¹ AI æ€»ç»“</h2>
                    <p>è¾“å…¥ Bilibili / YouTube è§†é¢‘é“¾æ¥<br>
                       è‡ªåŠ¨æå–å­—å¹• â†’ AI æ·±åº¦æ€»ç»“ â†’ å³æ—¶é¢„è§ˆ<br><br>
                       <span style="color: var(--accent2);">âœ¨ ä¼˜å…ˆä½¿ç”¨å®˜æ–¹å­—å¹•ï¼Œæ— å­—å¹•æ—¶è‡ªåŠ¨è½¬å½•</span>
                    </p>
                </div>
                <!-- è¿›åº¦æŒ‡ç¤ºï¼ˆå¤„ç†ä¸­æ˜¾ç¤ºï¼‰ -->
                <div id="progressPanel" style="display:none;">
                    <div class="progress-wrap">
                        <div class="spinner-lg" id="progressSpinner"></div>
                        <div class="progress-percent" id="progressPercent" style="display:none;">0%</div>
                        <div class="progress-bar-wrap" id="progressBarWrap" style="display:none;">
                            <div class="progress-bar-fill" id="progressBarFill"></div>
                        </div>
                        <div class="progress-info" id="progressInfo">æ­£åœ¨å¤„ç†...</div>
                        <div class="progress-detail" id="progressDetail" style="display:none;"></div>
                    </div>
                </div>
                <!-- AI æ€»ç»“ Tab -->
                <div class="markdown-body" id="summaryContent" style="display:none;"></div>
                <!-- åŸå§‹å­—å¹• Tab -->
                <div class="transcript-panel" id="transcriptContent" style="display:none;"></div>
            </div>
        </div>

        <div class="col-splitter" id="splitterRight" title="æ‹–æ‹½è°ƒæ•´èŠå¤©æ å®½åº¦"></div>

        <!-- å³ä¾§ï¼šèŠå¤© -->
        <div class="panel-right main-col" id="chatCol">
            <div class="chat-header">
                ğŸ’¬ AI åŠ©æ‰‹ Â· åŸºäºè§†é¢‘å†…å®¹å¯¹è¯
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-empty" id="chatEmpty">
                    è§†é¢‘åˆ†æå®Œæˆåï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œ<br>
                    é’ˆå¯¹è§†é¢‘å†…å®¹è¿›è¡Œæé—®å’Œè®¨è®º ğŸ—£ï¸
                </div>
            </div>
            <div class="chat-input-wrap">
                <textarea id="chatInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." rows="1" 
                          disabled onkeydown="handleChatKey(event)"></textarea>
                <button class="btn-voice" id="btnVoice" disabled onclick="toggleVoiceInput()" title="è¯­éŸ³è¾“å…¥">ğŸ™ï¸</button>
                <button class="btn-send" id="btnSend" disabled onclick="sendChat()">â¤</button>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥ marked.js ç”¨äº Markdown æ¸²æŸ“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        // â”€â”€ çŠ¶æ€ â”€â”€
        let currentTaskId = null;
        let currentTranscript = '';
        let currentVideoUrl = '';
        let chatSessionId = '';
        let currentProjectId = '';
        let pollTimer = null;
        let chatEnabled = false;
        let currentTab = 'summary';
        let currentThumbnail = '';
        let activeTagFilter = '';    // å½“å‰ç­›é€‰çš„æ ‡ç­¾ï¼Œç©º=å…¨éƒ¨
        let allTags = [];            // å…¨éƒ¨æ ‡ç­¾åˆ—è¡¨
        let allProjects = [];        // ç¼“å­˜é¡¹ç›®åˆ—è¡¨ï¼ˆç”¨äºå‰ç«¯ç­›é€‰ï¼‰
        let currentProjectTag = '';  // å½“å‰é¡¹ç›®çš„æ ‡ç­¾
        let layoutState = {
            sidebarWidth: 300,
            chatWidth: 420,
            sidebarVisible: true,
            chatVisible: true,
            sidebarLocked: false,
            chatLocked: false,
        };

        function buildThumbProxyUrl(projectId, thumbUrl) {
            if (!projectId) return '';
            const q = thumbUrl ? ('?src=' + encodeURIComponent(thumbUrl)) : '';
            return `/api/projects/${encodeURIComponent(projectId)}/thumbnail${q}`;
        }

        function loadLayoutState() {
            try {
                const raw = localStorage.getItem('zimu_layout_state');
                if (!raw) return;
                layoutState = { ...layoutState, ...JSON.parse(raw) };
            } catch (e) {}
        }

        function saveLayoutState() {
            localStorage.setItem('zimu_layout_state', JSON.stringify(layoutState));
        }

        function applyLayoutState() {
            const sidebar = document.getElementById('sidebarCol');
            const chat = document.getElementById('chatCol');
            const splitL = document.getElementById('splitterLeft');
            const splitR = document.getElementById('splitterRight');

            if (!sidebar || !chat || !splitL || !splitR) return;

            sidebar.classList.toggle('hidden', !layoutState.sidebarVisible);
            chat.classList.toggle('hidden', !layoutState.chatVisible);
            splitL.classList.toggle('hidden', !layoutState.sidebarVisible);
            splitR.classList.toggle('hidden', !layoutState.chatVisible);
            splitL.classList.toggle('locked', layoutState.sidebarLocked);
            splitR.classList.toggle('locked', layoutState.chatLocked);

            const sw = Math.max(220, Math.min(560, Number(layoutState.sidebarWidth) || 300));
            const cw = Math.max(320, Math.min(860, Number(layoutState.chatWidth) || 420));
            layoutState.sidebarWidth = sw;
            layoutState.chatWidth = cw;

            sidebar.style.flex = `0 0 ${sw}px`;
            sidebar.style.width = `${sw}px`;
            chat.style.flex = `0 0 ${cw}px`;
            chat.style.width = `${cw}px`;

            document.getElementById('btnToggleSidebar')?.classList.toggle('active', layoutState.sidebarVisible);
            document.getElementById('btnToggleChat')?.classList.toggle('active', layoutState.chatVisible);
            document.getElementById('btnLockSidebar')?.classList.toggle('active', layoutState.sidebarLocked);
            document.getElementById('btnLockChat')?.classList.toggle('active', layoutState.chatLocked);

            saveLayoutState();
        }

        function setupLayoutControls() {
            const splitL = document.getElementById('splitterLeft');
            const splitR = document.getElementById('splitterRight');

            splitL?.addEventListener('mousedown', (e) => {
                if (layoutState.sidebarLocked || !layoutState.sidebarVisible) return;
                e.preventDefault();
                const startX = e.clientX;
                const startW = layoutState.sidebarWidth;
                const onMove = (ev) => {
                    layoutState.sidebarWidth = startW + (ev.clientX - startX);
                    applyLayoutState();
                };
                const onUp = () => {
                    window.removeEventListener('mousemove', onMove);
                    window.removeEventListener('mouseup', onUp);
                };
                window.addEventListener('mousemove', onMove);
                window.addEventListener('mouseup', onUp);
            });

            splitR?.addEventListener('mousedown', (e) => {
                if (layoutState.chatLocked || !layoutState.chatVisible) return;
                e.preventDefault();
                const startX = e.clientX;
                const startW = layoutState.chatWidth;
                const onMove = (ev) => {
                    layoutState.chatWidth = startW - (ev.clientX - startX);
                    applyLayoutState();
                };
                const onUp = () => {
                    window.removeEventListener('mousemove', onMove);
                    window.removeEventListener('mouseup', onUp);
                };
                window.addEventListener('mousemove', onMove);
                window.addEventListener('mouseup', onUp);
            });

            document.getElementById('btnToggleSidebar')?.addEventListener('click', () => {
                layoutState.sidebarVisible = !layoutState.sidebarVisible;
                applyLayoutState();
            });
            document.getElementById('btnToggleChat')?.addEventListener('click', () => {
                layoutState.chatVisible = !layoutState.chatVisible;
                applyLayoutState();
            });
            document.getElementById('btnLockSidebar')?.addEventListener('click', () => {
                layoutState.sidebarLocked = !layoutState.sidebarLocked;
                applyLayoutState();
            });
            document.getElementById('btnLockChat')?.addEventListener('click', () => {
                layoutState.chatLocked = !layoutState.chatLocked;
                applyLayoutState();
            });
        }

        // â”€â”€ ä¸»é¢˜åˆ‡æ¢ â”€â”€
        function applyTheme(theme) {
            const t = theme || 'happy';
            if (t === 'happy') {
                document.documentElement.removeAttribute('data-theme');
            } else {
                document.documentElement.setAttribute('data-theme', t);
            }
            localStorage.setItem('zimu_theme', t);
        }

        // ç»‘å®šä¸»é¢˜é€‰æ‹©å™¨
        document.getElementById('themeSelect').addEventListener('change', (e) => {
            applyTheme(e.target.value);
        });

        // â”€â”€ è§†é¢‘å…ƒä¿¡æ¯æ¸²æŸ“ â”€â”€
        function renderVideoMeta(obj) {
            const card = document.getElementById('videoCard');
            if (!card) return;

            const url = (obj && obj.video_url) ? String(obj.video_url) : (currentVideoUrl || '');
            const title = (obj && obj.title) ? String(obj.title).trim() : '';
            const uploader = (obj && obj.uploader) ? String(obj.uploader).trim() : '';
            const date = (obj && obj.upload_date) ? String(obj.upload_date).trim() : '';
            const thumb = (obj && obj.thumbnail) ? String(obj.thumbnail).trim() : '';
            currentThumbnail = thumb || currentThumbnail;

            if (!url && !title && !thumb) {
                card.style.display = 'none';
                return;
            }

            card.style.display = 'flex';
            const linkEl = document.getElementById('videoLink');
            const urlTextEl = document.getElementById('videoUrlText');

            if (url) {
                linkEl.href = url;
                urlTextEl.href = url;
                urlTextEl.style.display = 'inline';
            } else {
                urlTextEl.style.display = 'none';
            }

            document.getElementById('videoTitle').textContent = title || displayTitle({ title: '', video_url: url });
            document.getElementById('videoUploader').textContent = uploader ? ('ğŸ‘¤ ' + uploader) : 'ğŸ‘¤ æœªçŸ¥ä½œè€…';
            document.getElementById('videoDate').textContent = date ? ('ğŸ—“ ' + date) : '';

            // ä½œè€…ä¸»é¡µé“¾æ¥
            const uploaderUrl = (obj && obj.uploader_url) ? String(obj.uploader_url).trim() : '';
            const uploaderLinkEl = document.getElementById('videoUploaderLink');
            if (uploaderUrl) {
                uploaderLinkEl.href = uploaderUrl;
                uploaderLinkEl.title = 'è®¿é—®ä½œè€…ä¸»é¡µ';
                uploaderLinkEl.style.cursor = 'pointer';
            } else {
                uploaderLinkEl.removeAttribute('href');
                uploaderLinkEl.style.cursor = 'default';
            }

            // ä½œè€…å¤´åƒ
            const avatarEl = document.getElementById('videoUploaderAvatar');
            const avatarUrl = (obj && obj.uploader_avatar) ? String(obj.uploader_avatar).trim() : '';
            const pidForAvatar = (obj && obj.id) ? obj.id : (currentProjectId || currentTaskId);
            if (avatarUrl && pidForAvatar) {
                const avatarProxyUrl = `/api/projects/${encodeURIComponent(pidForAvatar)}/avatar`;
                avatarEl.src = avatarProxyUrl;
                avatarEl.style.display = 'inline-block';
                avatarEl.onerror = function() { this.style.display = 'none'; };
            } else {
                avatarEl.style.display = 'none';
            }

            const img = document.getElementById('videoCover');
            const pid = (obj && obj.id) ? obj.id : (currentProjectId || currentTaskId);
            if (thumb || pid) {
                const proxyUrl = buildThumbProxyUrl(pid, thumb || currentThumbnail);
                if (proxyUrl) {
                    img.onerror = function () {
                        if (thumb) {
                            this.onerror = null;
                            this.src = thumb;
                            this.style.visibility = 'visible';
                        } else {
                            this.style.visibility = 'hidden';
                        }
                    };
                    img.src = proxyUrl;
                } else if (thumb) {
                    img.src = thumb;
                }
                img.style.visibility = 'visible';
            } else {
                img.removeAttribute('src');
                img.style.visibility = 'hidden';
            }
        }

        // â”€â”€ æ ‡ç­¾ç®¡ç† â”€â”€
        async function loadTags() {
            try {
                const resp = await fetch('/api/tags');
                allTags = await resp.json();
            } catch (e) {
                allTags = ['æ”¿æ²»', 'ç§‘æŠ€', 'ç”Ÿæ´»'];
            }
            renderTagFilter();
            renderTagSelect();
        }

        function renderTagFilter() {
            const bar = document.getElementById('tagFilterBar');
            // è®¡ç®—å„æ ‡ç­¾çš„é¡¹ç›®æ•°é‡
            const totalCount = allProjects.length;
            const favCount = allProjects.filter(p => p.favorite).length;
            const tagCounts = {};
            for (const tag of allTags) tagCounts[tag] = 0;
            for (const p of allProjects) {
                if (p.tag && tagCounts.hasOwnProperty(p.tag)) tagCounts[p.tag]++;
            }
            let html = '';
            // "å…¨éƒ¨" chip
            html += `<span class="tag-chip${activeTagFilter === '' ? ' active' : ''}" onclick="setTagFilter('')">å…¨éƒ¨ <span class="tag-count">${totalCount}</span></span>`;
            // â­ æ”¶è— chip
            html += `<span class="tag-chip${activeTagFilter === 'â­' ? ' active' : ''}" onclick="setTagFilter('â­')">â­ æ”¶è—${favCount ? ` <span class="tag-count">${favCount}</span>` : ''}</span>`;
            for (const tag of allTags) {
                const active = (activeTagFilter === tag) ? ' active' : '';
                const cnt = tagCounts[tag] || 0;
                html += `<span class="tag-chip${active}" onclick="setTagFilter('${escapeHtml(tag)}')">${escapeHtml(tag)}${cnt ? ` <span class="tag-count">${cnt}</span>` : ''}<span class="tag-del" onclick="event.stopPropagation(); removeTag('${escapeHtml(tag)}')" title="åˆ é™¤æ ‡ç­¾">âœ•</span></span>`;
            }
            html += `<span class="tag-chip-add" onclick="addNewTag()">ï¼‹</span>`;
            bar.innerHTML = html;
        }

        function renderTagSelect() {
            const sel = document.getElementById('tagSelect');
            let html = '<option value="">æœªåˆ†ç±»</option>';
            for (const tag of allTags) {
                const selected = (tag === currentProjectTag) ? ' selected' : '';
                html += `<option value="${escapeHtml(tag)}"${selected}>${escapeHtml(tag)}</option>`;
            }
            sel.innerHTML = html;
        }

        function setTagFilter(tag) {
            activeTagFilter = tag;
            renderTagFilter();
            renderProjectList(allProjects);
        }

        async function addNewTag() {
            const name = prompt('è¯·è¾“å…¥æ–°æ ‡ç­¾åç§°ï¼š');
            if (!name || !name.trim()) return;
            try {
                const resp = await fetch('/api/tags', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name.trim() })
                });
                const data = await resp.json();
                if (data.error) {
                    alert(data.error);
                    return;
                }
                allTags = data.tags;
                renderTagFilter();
                renderTagSelect();
            } catch (e) {
                alert('æ·»åŠ å¤±è´¥: ' + e.message);
            }
        }

        async function removeTag(name) {
            if (!confirm(`ç¡®è®¤åˆ é™¤æ ‡ç­¾ã€Œ${name}ã€å—ï¼Ÿå·²åˆ†ç±»çš„é¡¹ç›®æ ‡ç­¾ä¸ä¼šè¢«æ¸…é™¤ã€‚`)) return;
            try {
                const resp = await fetch('/api/tags', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                const data = await resp.json();
                if (data.error) {
                    alert(data.error);
                    return;
                }
                allTags = data.tags;
                if (activeTagFilter === name) activeTagFilter = '';
                renderTagFilter();
                renderTagSelect();
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        }

        async function onTagSelectChange(tag) {
            currentProjectTag = tag;
            const pid = currentProjectId || currentTaskId;
            if (!pid || pid === '__new__') return;
            try {
                await fetch('/api/projects/' + pid, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tag })
                });
                await refreshProjects();
            } catch (e) {
                console.error('æ›´æ–°æ ‡ç­¾å¤±è´¥:', e);
            }
        }

        async function classifyAllProjects() {
            if (!confirm('å°†ä¸ºæ‰€æœ‰æœªåˆ†ç±»çš„é¡¹ç›®è‡ªåŠ¨æ·»åŠ æ ‡ç­¾ï¼Œç¡®è®¤ï¼Ÿ')) return;
            showStatus('ğŸ·ï¸ æ­£åœ¨æ‰¹é‡åˆ†ç±»â€¦', '');
            try {
                const resp = await fetch('/api/classify-all', { method: 'POST' });
                const data = await resp.json();
                if (data.error) {
                    showStatus('âŒ ' + data.error, 'error');
                    return;
                }
                showStatus(`ğŸ·ï¸ åˆ†ç±»å®Œæˆï¼š${data.classified} ä¸ªæˆåŠŸï¼Œ${data.failed} ä¸ªå¤±è´¥`, 'success');
                await refreshProjects();
            } catch (e) {
                showStatus('âŒ æ‰¹é‡åˆ†ç±»å¤±è´¥: ' + e.message, 'error');
            }
        }

        // â”€â”€ é¡¹ç›®åˆ—è¡¨ â”€â”€
        async function refreshProjects() {
            const listEl = document.getElementById('projectList');
            try {
                const resp = await fetch('/api/projects');
                allProjects = await resp.json();
                renderProjectList(allProjects);
            } catch (e) {
                listEl.innerHTML = '<div class="project-empty">âŒ åŠ è½½å¤±è´¥</div>';
            }
        }

        function sourcePill(source) {
            if (source === 'official') return '<span class="pill pill-ok">å®˜æ–¹</span>';
            if (source === 'auto_generated') return '<span class="pill pill-a">è‡ªåŠ¨</span>';
            if (source === 'whisper') return '<span class="pill pill-w">Whisper</span>';
            return '<span class="pill">æœªçŸ¥</span>';
        }

        function statusPill(p) {
            const s = (p && p.status) ? String(p.status) : '';
            const pct = (p && typeof p.transcribe_percent === 'number') ? p.transcribe_percent : 0;
            if (s === 'done') return '';
            if (s === 'error') return '<span class="pill" style="border-color: color-mix(in srgb, var(--error) 45%, transparent); color: var(--error);">å¤±è´¥</span>';
            if (s === 'transcribing') {
                const n = pct > 0 ? Math.floor(pct) + '%' : 'è½¬å½•ä¸­';
                return `<span class="pill" style="border-color: color-mix(in srgb, var(--accent) 45%, transparent); color: var(--accent);">${n}</span>`;
            }
            if (s === 'downloading') return '<span class="pill" style="border-color: color-mix(in srgb, var(--warn) 45%, transparent); color: var(--warn);">ä¸‹è½½ä¸­</span>';
            if (s === 'checking_subtitles') return '<span class="pill" style="border-color: color-mix(in srgb, var(--warn) 45%, transparent); color: var(--warn);">æ£€æµ‹å­—å¹•</span>';
            if (s === 'summarizing') return '<span class="pill" style="border-color: color-mix(in srgb, var(--warn) 45%, transparent); color: var(--warn);">æ€»ç»“ä¸­</span>';
            if (s === 'pending') return '<span class="pill">æ’é˜Ÿä¸­</span>';
            return '<span class="pill">å¤„ç†ä¸­</span>';
        }

        function displayTitle(p) {
            const t = (p && p.title) ? String(p.title).trim() : '';
            // åç«¯å¯èƒ½å·²ç»ç»™äº†ä¸€ä¸ªçŸ­ titleï¼ˆå¦‚ï¼šBç«™ BVxxxx / YouTube xxxxï¼‰
            if (t && t !== 'æœªå‘½åé¡¹ç›®' && t !== 'æœªå‘½åé¡¹ç›® ') return t;

            const u = (p && p.video_url) ? String(p.video_url).trim() : '';
            const nice = inferTitleFromUrl(u);
            if (nice) return nice;
            if (u) return u;
            return 'æœªå‘½åé¡¹ç›®';
        }

        function inferTitleFromUrl(url) {
            if (!url) return '';
            try {
                const u = new URL(url);
                const host = (u.hostname || '').toLowerCase();
                const path = u.pathname || '';

                // bilibili.com/video/BVxxxx
                if (host.includes('bilibili.com')) {
                    const m = path.match(/\/video\/(BV[0-9A-Za-z]+)/i);
                    if (m && m[1]) return 'Bç«™ ' + m[1];
                    return 'Bç«™è§†é¢‘';
                }
                // b23.tv/xxxx
                if (host.endsWith('b23.tv')) {
                    const code = path.replace(/^\/+|\/+$/g, '').split('/')[0];
                    return code ? ('Bç«™çŸ­é“¾ ' + code) : 'Bç«™çŸ­é“¾';
                }
                // youtube
                if (host.includes('youtube.com')) {
                    const vid = u.searchParams.get('v');
                    return vid ? ('YouTube ' + vid) : 'YouTube è§†é¢‘';
                }
                if (host.endsWith('youtu.be')) {
                    const vid = path.replace(/^\/+|\/+$/g, '').split('/')[0];
                    return vid ? ('YouTube ' + vid) : 'YouTube è§†é¢‘';
                }
            } catch (e) {
                // éæ ‡å‡† URLï¼Œå°½é‡çŸ­æ˜¾ç¤º
                if (url.length > 48) return url.slice(0, 48) + 'â€¦';
                return url;
            }
            // å…¶ä»–ç«™ç‚¹ï¼šæˆªæ–­æ˜¾ç¤º
            return url.length > 48 ? url.slice(0, 48) + 'â€¦' : url;
        }

        function renderProjectList(projects) {
            const listEl = document.getElementById('projectList');
            let html = '';

            // æ–°å»ºé¡¹ç›®å ä½å¡ç‰‡
            if (currentProjectId === '__new__') {
                html += `
                <div class="project-item active" style="border-style:dashed;">
                    <div class="project-row">
                        <div class="project-name" style="color:var(--accent);">âœ¨ æ–°é¡¹ç›®</div>
                        <div class="project-right">
                            <span class="pill" style="border-color: color-mix(in srgb, var(--accent) 45%, transparent); color: var(--accent);">å¾…è¾“å…¥</span>
                        </div>
                    </div>
                    <div class="project-meta">
                        <span>ç²˜è´´è§†é¢‘é“¾æ¥å¼€å§‹åˆ†æ</span>
                    </div>
                </div>`;
            }

            // æŒ‰æ ‡ç­¾/æ”¶è—ç­›é€‰
            let filtered = Array.isArray(projects) ? projects : [];
            if (activeTagFilter === 'â­') {
                filtered = filtered.filter(p => p.favorite);
            } else if (activeTagFilter) {
                filtered = filtered.filter(p => (p.tag || '') === activeTagFilter);
            }

            if (filtered.length === 0) {
                if (!html) {
                    let msg = 'è¿˜æ²¡æœ‰é¡¹ç›®ã€‚\n\nåœ¨ä¸Šæ–¹ç²˜è´´é“¾æ¥å¹¶å¼€å§‹åˆ†æã€‚';
                    if (activeTagFilter === 'â­') msg = 'è¿˜æ²¡æœ‰æ”¶è—çš„é¡¹ç›®';
                    else if (activeTagFilter) msg = `ã€Œ${escapeHtml(activeTagFilter)}ã€ä¸‹è¿˜æ²¡æœ‰é¡¹ç›®`;
                    listEl.innerHTML = `<div class="project-empty">${msg}</div>`;
                    return;
                }
                listEl.innerHTML = html;
                return;
            }

            // æŒ‰æ—¥æœŸåˆ†ç»„
            let lastDateLabel = '';
            for (const p of filtered) {
                // ä» created_at (å¦‚ "2025-07-09 14:30:00") æå–æ—¥æœŸæ ‡ç­¾
                const dateLabel = _extractDateLabel(p.created_at || '');
                if (dateLabel && dateLabel !== lastDateLabel) {
                    html += `<div class="date-group-header">${escapeHtml(dateLabel)}</div>`;
                    lastDateLabel = dateLabel;
                }

                const active = (p.id === currentProjectId) ? ' active' : '';
                const title = escapeHtml(displayTitle(p));
                const isFav = p.favorite ? true : false;
                const favClass = isFav ? ' is-fav' : '';
                const favIcon = isFav ? 'â˜…' : 'â˜†';
                const tagHtml = p.tag ? `<span class="project-tag">${escapeHtml(p.tag)}</span>` : '';
                const uploader = p.uploader ? escapeHtml(p.uploader) : '';
                const uploadDate = p.upload_date ? escapeHtml(p.upload_date) : '';
                const metaParts = [uploader, uploadDate].filter(Boolean).join(' Â· ');
                const thumbSrc = p.thumbnail ? buildThumbProxyUrl(p.id, p.thumbnail) : '';
                html += `
                <div class="project-item${active}" data-id="${p.id}" onclick="loadProject('${p.id}')">
                    <div class="project-row">
                        ${thumbSrc ? `<img class="project-thumb" src="${thumbSrc}" loading="lazy" onerror="this.style.display='none'">` : ''}
                        <div style="flex:1;min-width:0">
                            <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px">
                                <div class="project-name">${title}</div>
                                <div class="project-right">
                                    <div class="project-right-row">
                                        <button class="project-fav${favClass}" title="${isFav ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—'}" onclick="event.stopPropagation(); toggleFavorite('${p.id}', ${!isFav})">${favIcon}</button>
                                        ${statusPill(p)}
                                        <button class="project-del" title="åˆ é™¤" onclick="event.stopPropagation(); deleteProject('${p.id}')">âœ•</button>
                                    </div>
                                    ${tagHtml}
                                </div>
                            </div>
                            ${metaParts ? `<div class="project-meta"><span>${metaParts}</span></div>` : ''}
                        </div>
                    </div>
                </div>`;
            }
            listEl.innerHTML = html;
        }

        function _extractDateLabel(createdAt) {
            if (!createdAt) return '';
            // "2025-07-09 14:30:00" â†’ "07/09"
            const m = createdAt.match(/^(\d{4})-(\d{2})-(\d{2})/);
            if (!m) return '';
            const year = m[1];
            const month = m[2];
            const day = m[3];
            const now = new Date();
            const currentYear = String(now.getFullYear());
            if (year === currentYear) {
                return `${month}/${day}`;
            }
            return `${year}/${month}/${day}`;
        }

        async function toggleFavorite(projectId, newState) {
            try {
                await fetch('/api/projects/' + projectId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ favorite: newState })
                });
                // æ›´æ–°æœ¬åœ°ç¼“å­˜
                const p = allProjects.find(x => x.id === projectId);
                if (p) p.favorite = newState;
                renderProjectList(allProjects);
            } catch (e) {
                console.error('æ”¶è—å¤±è´¥:', e);
            }
        }

        async function deleteProject(projectId) {
            if (!confirm('ç¡®è®¤åˆ é™¤è¯¥é¡¹ç›®å—ï¼Ÿ')) return;
            try {
                const resp = await fetch('/api/projects/' + projectId, { method: 'DELETE' });
                const data = await resp.json();
                if (data.ok) {
                    if (currentProjectId === projectId) {
                        newProjectView();
                    }
                    await refreshProjects();
                } else {
                    alert(data.error || 'åˆ é™¤å¤±è´¥');
                }
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        }

        function newProjectView() {
            // æ¸…ç©ºä¸»è§†å›¾ï¼Œä½†ä¿ç•™é¡¹ç›®åˆ—è¡¨
            currentTaskId = null;
            currentProjectId = '__new__';  // æ ‡è®°ä¸ºæ–°å»ºé¡¹ç›®
            currentTranscript = '';
            currentVideoUrl = '';
            currentThumbnail = '';
            chatSessionId = '';
            if (pollTimer) {
                clearInterval(pollTimer);
                pollTimer = null;
            }

            document.getElementById('btnProcess').disabled = false;
            document.getElementById('tabBar').style.display = 'none';
            document.getElementById('segCountBadge').style.display = 'none';
            document.getElementById('progressPanel').style.display = 'none';
            document.getElementById('summaryContent').style.display = 'none';
            document.getElementById('summaryContent').innerHTML = '';
            document.getElementById('transcriptContent').style.display = 'none';
            document.getElementById('transcriptContent').innerHTML = '';
            document.getElementById('videoCard').style.display = 'none';
            document.getElementById('emptyState').style.display = 'flex';
            resetChat();
            showStatus('å°±ç»ª â€” è¾“å…¥è§†é¢‘é“¾æ¥å¼€å§‹ä½¿ç”¨', '');
            history.replaceState(null, '', location.pathname);
            refreshProjects();
            // èšç„¦åˆ°è¾“å…¥æ¡†
            const urlInput = document.getElementById('urlInput');
            if (urlInput) urlInput.focus();
        }

        async function loadProject(projectId) {
            try {
                const resp = await fetch('/api/projects/' + projectId);
                const p = await resp.json();
                if (p.error) {
                    showStatus('âŒ ' + p.error, 'error');
                    return;
                }
                currentProjectId = p.id;
                // å¦‚æœé¡¹ç›®ä»åœ¨å¤„ç†ä¸­ï¼Œåˆ™é™„ç€åˆ°è½®è¯¢ä¸Š
                const isRunning = p.status && !['done', 'error'].includes(p.status);
                currentTaskId = isRunning ? p.id : null;
                chatSessionId = 'session_' + p.id;
                currentVideoUrl = p.video_url || '';
                currentTranscript = p.transcript || '';
                currentProjectTag = p.tag || '';
                _lastRenderedSegCount = 0;
                _lastRenderedMetaKey = '';

                renderVideoMeta(p);
                renderTagSelect();
                const tagSelectEl = document.getElementById('tagSelect');
                if (tagSelectEl) tagSelectEl.value = currentProjectTag;

                if (pollTimer) {
                    clearInterval(pollTimer);
                    pollTimer = null;
                }

                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('tabBar').style.display = 'flex';

                // è¿›è¡Œä¸­ï¼šå±•ç¤ºè¿›åº¦é¢æ¿ï¼Œå¹¶å¼€å§‹è½®è¯¢
                if (isRunning) {
                    document.getElementById('progressPanel').style.display = 'block';
                    document.getElementById('summaryContent').style.display = 'none';
                    document.getElementById('transcriptContent').style.display = 'none';
                    resetChat();
                    pollStatus();
                } else {
                    document.getElementById('progressPanel').style.display = 'none';
                }

                renderSummary(p.summary || '');
                if (p.segments && p.segments.length > 0) {
                    renderTranscript(p.segments, currentVideoUrl);
                } else {
                    document.getElementById('transcriptContent').innerHTML = '<div style="color:var(--text2);text-align:center;padding:40px;">æš‚æ— å­—å¹•æ•°æ®</div>';
                }
                switchTab('summary');
                // æ¸²æŸ“èŠå¤©å†å²ï¼ˆå¯èƒ½ä¼šé‡å»º chatEmptyï¼‰
                renderChatHistory(p.chat_history || []);
                if (!isRunning) {
                    enableChat();
                }

                // é«˜äº®åˆ—è¡¨
                refreshProjects();
                showStatus(`âœ… å·²æ‰“å¼€ï¼š<strong>${escapeHtml(p.title || 'æœªçŸ¥æ ‡é¢˜')}</strong>`, 'success');
                location.hash = '#' + p.id;
            } catch (e) {
                showStatus('âŒ åŠ è½½é¡¹ç›®å¤±è´¥: ' + e.message, 'error');
            }
        }

        function renderChatHistory(historyList) {
            const container = document.getElementById('chatMessages');
            container.innerHTML = '';
            if (!Array.isArray(historyList) || historyList.length === 0) {
                container.innerHTML = '<div class="chat-empty" id="chatEmpty">å·²åŠ è½½é¡¹ç›®ã€‚ä½ å¯ä»¥ç»§ç»­è¿½é—® ğŸ—£ï¸</div>';
                return;
            }
            for (const msg of historyList) {
                if (!msg || typeof msg !== 'object') continue;
                if (msg.role === 'user') appendMessage('user', msg.content || '');
                else if (msg.role === 'assistant') appendMessage('ai', msg.content || '');
            }
        }

        // â”€â”€ Tab åˆ‡æ¢ â”€â”€
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.tab === tab);
            });
            document.getElementById('summaryContent').style.display = tab === 'summary' ? 'block' : 'none';
            document.getElementById('transcriptContent').style.display = tab === 'transcript' ? 'block' : 'none';
        }

        // â”€â”€ æ„å»ºè§†é¢‘è·³è½¬ URL â”€â”€
        function buildJumpUrl(videoUrl, seconds) {
            const sec = Math.floor(seconds);
            try {
                const u = new URL(videoUrl);
                // Bç«™
                if (u.hostname.includes('bilibili.com')) {
                    u.searchParams.set('t', sec);
                    return u.toString();
                }
                // YouTube
                if (u.hostname.includes('youtube.com') || u.hostname.includes('youtu.be')) {
                    u.searchParams.set('t', sec + 's');
                    return u.toString();
                }
            } catch(e) {}
            return videoUrl;
        }

        // â”€â”€ æ ¼å¼åŒ–æ—¶é—´æˆ³ â”€â”€
        function fmtTs(seconds) {
            const s = Math.floor(seconds);
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = s % 60;
            if (h > 0) return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
            return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
        }

        // â”€â”€ æ¸²æŸ“å­—å¹•é¢æ¿ â”€â”€
        function renderTranscript(segments, videoUrl) {
            const el = document.getElementById('transcriptContent');
            if (!segments || segments.length === 0) {
                el.innerHTML = '<div style="color:var(--text2);text-align:center;padding:40px;">æš‚æ— å­—å¹•æ•°æ®</div>';
                return;
            }
            let html = '';
            for (const seg of segments) {
                const ts = fmtTs(seg.start);
                const jumpUrl = buildJumpUrl(videoUrl, seg.start);
                html += `<div class="transcript-line">` +
                    `<a class="ts-link" href="${jumpUrl}" target="_blank" title="è·³è½¬åˆ°è§†é¢‘ ${ts}">${ts}</a>` +
                    `<span class="transcript-text">${escapeHtml(seg.text)}</span>` +
                    `</div>`;
            }
            el.innerHTML = html;

            // æ›´æ–° badge
            const badge = document.getElementById('segCountBadge');
            if (badge) {
                badge.textContent = segments.length;
                badge.style.display = 'inline-block';
            }
        }

        function escapeHtml(str) {
            const d = document.createElement('div');
            d.textContent = str;
            return d.innerHTML;
        }

        function extractFirstUrl(raw) {
            const text = (raw || '').trim();
            if (!text) return '';

            const direct = text.match(/https?:\/\/[^\s<>"'\u3000]+/i);
            if (direct && direct[0]) return direct[0].trim();

            const bare = text.match(/(?:b23\.tv|bilibili\.com|youtube\.com|youtu\.be)\/[^\s<>"'\u3000]*/i);
            if (bare && bare[0]) return `https://${bare[0].trim()}`;

            return '';
        }

        // â”€â”€ å¼€å§‹å¤„ç† â”€â”€
        async function startProcess() {
            const input = document.getElementById('urlInput');
            const raw = input.value.trim();
            const url = extractFirstUrl(raw);
            if (!url) {
                showStatus('âš ï¸ æœªè¯†åˆ«åˆ°æœ‰æ•ˆé“¾æ¥ï¼Œè¯·ç²˜è´´å®Œæ•´è§†é¢‘ URL', 'error');
                return;
            }
            if (url !== raw) {
                input.value = url;
            }

            // é‡ç½®
            document.getElementById('btnProcess').disabled = true;
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('videoCard').style.display = 'none';
            document.getElementById('summaryContent').style.display = 'none';
            document.getElementById('summaryContent').innerHTML = '';
            document.getElementById('transcriptContent').style.display = 'none';
            document.getElementById('transcriptContent').innerHTML = '';
            document.getElementById('tabBar').style.display = 'none';
            document.getElementById('segCountBadge').style.display = 'none';
            document.getElementById('progressPanel').style.display = 'block';
            document.getElementById('progressInfo').textContent = 'æ­£åœ¨å¤„ç†...';
            currentVideoUrl = '';
            _lastRenderedSegCount = 0;
            _lastRenderedMetaKey = '';
            resetChat();
            showStatus('<div class="spinner"></div> ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨å¤„ç†...', '');

            try {
                const resp = await fetch('/api/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await resp.json();
                if (data.error) {
                    showStatus('âŒ ' + data.error, 'error');
                    document.getElementById('btnProcess').disabled = false;
                    document.getElementById('progressPanel').style.display = 'none';
                    return;
                }
                currentTaskId = data.task_id;
                currentProjectId = data.task_id;  // ç«‹åˆ»å…³è”åˆ°çœŸå®é¡¹ç›®
                chatSessionId = 'session_' + data.task_id;
                refreshProjects();  // åˆ·æ–°åˆ—è¡¨æ˜¾ç¤ºè¿›è¡Œä¸­çš„ä»»åŠ¡
                pollStatus();
            } catch (e) {
                showStatus('âŒ ç½‘ç»œé”™è¯¯: ' + e.message, 'error');
                document.getElementById('btnProcess').disabled = false;
                document.getElementById('progressPanel').style.display = 'none';
            }
        }

        let _lastRenderedSegCount = 0;   // ä¸Šæ¬¡æ¸²æŸ“çš„å­—å¹•æ®µæ•°
        let _lastRenderedMetaKey = '';    // ä¸Šæ¬¡æ¸²æŸ“çš„è§†é¢‘å…ƒä¿¡æ¯æŒ‡çº¹

        // â”€â”€ è½®è¯¢çŠ¶æ€ â”€â”€
        function pollStatus() {
            if (!currentTaskId) return;
            pollTimer = setInterval(async () => {
                try {
                    const resp = await fetch('/api/status/' + currentTaskId);
                    const task = await resp.json();

                    // çŠ¶æ€æ 
                    let badge = '';
                    if (task.subtitle_source === 'official') {
                        badge = '<span class="subtitle-badge badge-official">å®˜æ–¹å­—å¹•</span>';
                    } else if (task.subtitle_source === 'auto_generated') {
                        badge = '<span class="subtitle-badge badge-auto">è‡ªåŠ¨å­—å¹•</span>';
                    } else if (task.subtitle_source === 'whisper') {
                        badge = '<span class="subtitle-badge badge-whisper">Whisper è½¬å½•</span>';
                    }

                    let titleInfo = task.title ? `<strong>${task.title}</strong> Â· ` : '';

                    // æ›´æ–°è¿›åº¦é¢æ¿
                    const progressInfo = document.getElementById('progressInfo');
                    progressInfo.innerHTML = task.message;

                    // è½¬å½•è¿›åº¦æ¡
                    const pctEl = document.getElementById('progressPercent');
                    const barWrap = document.getElementById('progressBarWrap');
                    const barFill = document.getElementById('progressBarFill');
                    const detailEl = document.getElementById('progressDetail');
                    const spinnerEl = document.getElementById('progressSpinner');

                    if (task.status === 'transcribing' && task.transcribe_percent > 0) {
                        pctEl.textContent = Math.floor(task.transcribe_percent) + '%';
                        pctEl.style.display = 'block';
                        barWrap.style.display = 'block';
                        barFill.style.width = task.transcribe_percent + '%';
                        spinnerEl.style.display = 'none';
                        // æ˜¾ç¤ºå¸§æ•°è¯¦æƒ…
                        if (task.transcribe_total > 0) {
                            const cur = task.transcribe_current.toLocaleString();
                            const tot = task.transcribe_total.toLocaleString();
                            detailEl.textContent = `${cur} / ${tot} frames`;
                            detailEl.style.display = 'block';
                        }
                    } else {
                        pctEl.style.display = 'none';
                        barWrap.style.display = 'none';
                        detailEl.style.display = 'none';
                        spinnerEl.style.display = 'block';
                        if (task.progress) {
                            progressInfo.innerHTML += `<br><small style="color:var(--accent2)">${task.progress}</small>`;
                        }
                    }

                    // å®æ—¶æ›´æ–°å­—å¹•ï¼ˆä»…åœ¨æ®µæ•°å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“ï¼Œé¿å…é—ªçƒï¼‰
                    if (task.segments && task.segments.length > 0 && task.video_url) {
                        currentVideoUrl = task.video_url;
                        if (task.segments.length !== _lastRenderedSegCount) {
                            _lastRenderedSegCount = task.segments.length;
                            renderTranscript(task.segments, task.video_url);
                        }
                    }

                    // å±•ç¤ºè§†é¢‘å…ƒä¿¡æ¯ï¼ˆä»…åœ¨å†…å®¹å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“ï¼Œé¿å…å°é¢å›¾ç‰‡é—ªçƒï¼‰
                    if (task.video_url || task.thumbnail || task.title) {
                        const metaKey = `${task.title || ''}|${task.uploader || ''}|${task.thumbnail || ''}|${task.uploader_avatar || ''}`;
                        if (metaKey !== _lastRenderedMetaKey) {
                            _lastRenderedMetaKey = metaKey;
                            renderVideoMeta(task);
                        }
                    }

                    if (task.status === 'done') {
                        clearInterval(pollTimer);
                        showStatus(`âœ… ${titleInfo}å¤„ç†å®Œæˆ ${badge}`, 'success');
                        document.getElementById('progressPanel').style.display = 'none';

                        // æ˜¾ç¤º Tab æ 
                        document.getElementById('tabBar').style.display = 'flex';

                        // æ¸²æŸ“æ€»ç»“
                        renderSummary(task.summary);
                        switchTab('summary');

                        // æ¸²æŸ“å­—å¹•
                        currentVideoUrl = task.video_url || '';
                        if (task.segments && task.segments.length > 0) {
                            renderTranscript(task.segments, currentVideoUrl);
                        }

                        currentTranscript = task.transcript;
                        enableChat();
                        document.getElementById('btnProcess').disabled = false;

                        // ä¿å­˜å®Œæˆååˆ·æ–°é¡¹ç›®åˆ—è¡¨å¹¶é€‰ä¸­å½“å‰é¡¹ç›®
                        currentProjectId = currentTaskId;
                        refreshProjects();
                        location.hash = '#' + currentProjectId;
                    } else if (task.status === 'error') {
                        clearInterval(pollTimer);
                        showStatus(task.message, 'error');
                        document.getElementById('btnProcess').disabled = false;
                        document.getElementById('progressPanel').style.display = 'none';

                        // å¦‚æœæœ‰éƒ¨åˆ†å­—å¹•ä¹Ÿå±•ç¤º
                        if (task.segments && task.segments.length > 0) {
                            document.getElementById('tabBar').style.display = 'flex';
                            renderTranscript(task.segments, task.video_url || '');
                            switchTab('transcript');
                        }
                    } else {
                        let spinner = '<div class="spinner"></div>';
                        showStatus(`${spinner} ${titleInfo}${task.message} ${badge}`, '');

                        // å¤„ç†ä¸­å¦‚æœæœ‰å­—å¹•äº†å°±æ˜¾ç¤º tab
                        if (task.segments && task.segments.length > 0) {
                            document.getElementById('tabBar').style.display = 'flex';
                        }
                    }
                } catch (e) {
                    // ç½‘ç»œé—®é¢˜ï¼Œç»§ç»­è½®è¯¢
                }
            }, 1500);
        }

        // â”€â”€ æ¸²æŸ“æ€»ç»“ â”€â”€
        function renderSummary(markdown) {
            const el = document.getElementById('summaryContent');
            let html = marked.parse(markdown);

            // åœ¨æ€»ç»“é¡¶éƒ¨æ’å…¥è§†é¢‘å°é¢
            const pid = currentProjectId || currentTaskId;
            const coverSrc = buildThumbProxyUrl(pid, currentThumbnail);
            let coverHtml = '';
            if (coverSrc) {
                coverHtml = `<div class="summary-cover-wrap"><img class="summary-cover-img" src="${coverSrc}" alt="è§†é¢‘å°é¢" onerror="this.parentElement.style.display='none'"></div>`;
            }

            // åå¤„ç†ï¼šå°† [MM:SS] æˆ– [HH:MM:SS] æˆ– [MM:SS-MM:SS] ç­‰æ—¶é—´æˆ³æ›¿æ¢ä¸ºå¯ç‚¹å‡»è·³è½¬é“¾æ¥
            if (currentVideoUrl) {
                html = html.replace(/\[(\d{1,2}:\d{2}(?::\d{2})?)(?:\s*[-â€“â€”~]\s*(\d{1,2}:\d{2}(?::\d{2})?))?\]/g, (match, tsStart, tsEnd) => {
                    const parts = tsStart.split(':').map(Number);
                    let totalSec;
                    if (parts.length === 3) {
                        totalSec = parts[0] * 3600 + parts[1] * 60 + parts[2];
                    } else {
                        totalSec = parts[0] * 60 + parts[1];
                    }
                    const jumpUrl = buildJumpUrl(currentVideoUrl, totalSec);
                    const display = tsEnd ? `[${tsStart}-${tsEnd}]` : `[${tsStart}]`;
                    return `<a class="ts-link" href="${jumpUrl}" target="_blank" title="è·³è½¬åˆ°è§†é¢‘ ${tsStart}">${display}</a>`;
                });
            }
            el.innerHTML = coverHtml + html;
            el.style.display = 'block';
        }

        // â”€â”€ çŠ¶æ€æ  â”€â”€
        function showStatus(html, type) {
            const bar = document.getElementById('statusBar');
            bar.innerHTML = html;
            bar.className = 'status-bar' + (type ? ' ' + type : '');
        }

        // â”€â”€ èŠå¤© â”€â”€
        function enableChat() {
            chatEnabled = true;
            document.getElementById('chatInput').disabled = false;
            document.getElementById('btnSend').disabled = false;
            document.getElementById('btnVoice').disabled = false;
            const emptyEl = document.getElementById('chatEmpty');
            if (emptyEl) {
                emptyEl.textContent = 'âœ… å·²åŠ è½½é¡¹ç›®ï¼Œç°åœ¨å¯ä»¥ç»§ç»­æé—®ï¼';
            }
        }

        function resetChat() {
            chatEnabled = false;
            document.getElementById('chatInput').disabled = true;
            document.getElementById('btnSend').disabled = true;
            document.getElementById('btnVoice').disabled = true;
            stopVoiceInput();
            document.getElementById('chatMessages').innerHTML = 
                '<div class="chat-empty" id="chatEmpty">è§†é¢‘åˆ†æå®Œæˆåï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œ<br>é’ˆå¯¹è§†é¢‘å†…å®¹è¿›è¡Œæé—®å’Œè®¨è®º ğŸ—£ï¸</div>';
        }

        let _isComposing = false;
        document.getElementById('chatInput').addEventListener('compositionstart', () => { _isComposing = true; });
        document.getElementById('chatInput').addEventListener('compositionend', () => { _isComposing = false; });

        function handleChatKey(e) {
            if (e.key === 'Enter' && !e.shiftKey && !_isComposing && !e.isComposing) {
                e.preventDefault();
                sendChat();
            }
        }

        // â”€â”€ è¯­éŸ³è¾“å…¥ â”€â”€
        let _speechRecognition = null;
        let _isRecording = false;

        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return null;
            const recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;

            let finalTranscript = '';
            const input = document.getElementById('chatInput');
            const cursorBefore = input.value;

            recognition.onresult = (event) => {
                let interim = '';
                finalTranscript = '';
                for (let i = 0; i < event.results.length; i++) {
                    const t = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += t;
                    } else {
                        interim += t;
                    }
                }
                // æŠŠå·²ç¡®è®¤å’Œä¸´æ—¶ç»“æœæ‹¼åˆ°è¾“å…¥æ¡†
                input.value = cursorBefore + finalTranscript + interim;
                autoResizeTextarea(input);
            };

            recognition.onerror = (event) => {
                console.warn('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                if (event.error === 'not-allowed') {
                    showStatus('âš ï¸ éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸', 'error');
                }
                stopVoiceInput();
            };

            recognition.onend = () => {
                // å¦‚æœç”¨æˆ·æ²¡æœ‰ä¸»åŠ¨åœæ­¢ï¼Œå¯èƒ½æ˜¯è‡ªåŠ¨è¶…æ—¶
                if (_isRecording) {
                    stopVoiceInput();
                }
            };

            return recognition;
        }

        function toggleVoiceInput() {
            if (_isRecording) {
                stopVoiceInput();
            } else {
                startVoiceInput();
            }
        }

        function startVoiceInput() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                showStatus('âš ï¸ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨ Chrome / Edge', 'error');
                return;
            }
            _speechRecognition = initSpeechRecognition();
            if (!_speechRecognition) return;
            _isRecording = true;
            const btn = document.getElementById('btnVoice');
            btn.classList.add('recording');
            btn.title = 'ç‚¹å‡»åœæ­¢å½•éŸ³';
            _speechRecognition.start();
            showStatus('ğŸ™ï¸ æ­£åœ¨å½•éŸ³â€¦ è¯´å®Œåç‚¹å‡»æŒ‰é’®åœæ­¢', '');
        }

        function stopVoiceInput() {
            _isRecording = false;
            const btn = document.getElementById('btnVoice');
            btn.classList.remove('recording');
            btn.title = 'è¯­éŸ³è¾“å…¥';
            if (_speechRecognition) {
                try { _speechRecognition.stop(); } catch(e) {}
                _speechRecognition = null;
            }
            showStatus('å°±ç»ª', '');
        }

        async function sendChat() {
            if (!chatEnabled) return;
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;

            input.value = '';
            autoResizeTextarea(input);

            // ç§»é™¤ç©ºçŠ¶æ€æç¤º
            const emptyEl = document.getElementById('chatEmpty');
            if (emptyEl) emptyEl.remove();

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            appendMessage('user', msg);

            // æ·»åŠ åŠ è½½æŒ‡ç¤º
            const loadingId = 'loading_' + Date.now();
            appendLoading(loadingId);

            // ç¦ç”¨è¾“å…¥
            document.getElementById('btnSend').disabled = true;
            input.disabled = true;

            // è®°ä½å‘é€æ—¶çš„ä¼šè¯ IDï¼Œç”¨äºåˆ¤æ–­å›æ¥åæ˜¯å¦è¿˜åœ¨åŒä¸€ä¸ªé¡¹ç›®
            const sentSessionId = chatSessionId;
            const sentProjectId = currentProjectId || currentTaskId;

            try {
                const resp = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sentSessionId,
                        message: msg,
                        transcript: currentTranscript
                    })
                });
                const data = await resp.json();

                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¿˜åœ¨åŒä¸€ä¸ªä¼šè¯
                if (chatSessionId === sentSessionId) {
                    // ä»åœ¨åŒä¸€é¡¹ç›®ï¼Œæ­£å¸¸æ›´æ–° DOM
                    removeLoading(loadingId);
                    if (data.error) {
                        appendMessage('ai', 'âŒ ' + data.error);
                    } else {
                        appendMessage('ai', data.reply);
                    }
                    input.disabled = false;
                    document.getElementById('btnSend').disabled = false;
                    input.focus();
                } else {
                    // ç”¨æˆ·å·²åˆ‡æ¢åˆ°åˆ«çš„é¡¹ç›®ï¼Œä¸æ“ä½œå½“å‰ DOM
                    // åç«¯å·²ç»æŠŠå›å¤å­˜åˆ°äº† chat_historyï¼Œç”¨æˆ·åˆ‡å›æ¥æ—¶ loadProject ä¼šåŠ è½½
                    // å¦‚æœç”¨æˆ·æ­¤æ—¶åˆšå¥½åˆ‡å›æ¥äº†ï¼Œä¸»åŠ¨åˆ·æ–°ä¸€ä¸‹èŠå¤©è®°å½•
                    if (sentProjectId && (currentProjectId === sentProjectId || currentTaskId === sentProjectId)) {
                        loadProject(sentProjectId);
                    }
                }
            } catch (e) {
                if (chatSessionId === sentSessionId) {
                    removeLoading(loadingId);
                    appendMessage('ai', 'âŒ ç½‘ç»œé”™è¯¯: ' + e.message);
                    input.disabled = false;
                    document.getElementById('btnSend').disabled = false;
                    input.focus();
                }
            }
        }

        function appendMessage(role, content) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = role === 'user' ? 'msg msg-user' : 'msg msg-ai';
            if (role === 'ai') {
                let html = marked.parse(content);
                // å°† [MM:SS] æˆ– [MM:SS-MM:SS] æ—¶é—´æˆ³è½¬ä¸ºå¯ç‚¹å‡»è·³è½¬é“¾æ¥
                if (currentVideoUrl) {
                    html = html.replace(/\[(\d{1,2}:\d{2}(?::\d{2})?)(?:\s*[-â€“â€”~]\s*(\d{1,2}:\d{2}(?::\d{2})?))?\]/g, (match, tsStart, tsEnd) => {
                        const parts = tsStart.split(':').map(Number);
                        let totalSec;
                        if (parts.length === 3) {
                            totalSec = parts[0] * 3600 + parts[1] * 60 + parts[2];
                        } else {
                            totalSec = parts[0] * 60 + parts[1];
                        }
                        const jumpUrl = buildJumpUrl(currentVideoUrl, totalSec);
                        const display = tsEnd ? `[${tsStart}-${tsEnd}]` : `[${tsStart}]`;
                        return `<a class="ts-link" href="${jumpUrl}" target="_blank" title="è·³è½¬åˆ°è§†é¢‘ ${tsStart}">${display}</a>`;
                    });
                }
                div.innerHTML = html;
            } else {
                div.textContent = content;
            }
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function appendLoading(id) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = 'msg msg-ai';
            div.id = id;
            div.innerHTML = '<div class="spinner" style="display:inline-block;vertical-align:middle;margin-right:8px;"></div> æ€è€ƒä¸­...';
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function removeLoading(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // â”€â”€ æ ‡é¢˜ç¼–è¾‘ â”€â”€
        (function setupTitleEditing() {
            const titleEl = document.getElementById('videoTitle');
            const hintEl = document.getElementById('titleEditHint');

            titleEl.addEventListener('click', function() {
                if (!currentProjectId || currentProjectId === '__new__') return;
                this.contentEditable = 'true';
                this.focus();
                // å…¨é€‰
                const range = document.createRange();
                range.selectNodeContents(this);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            });

            titleEl.addEventListener('blur', async function() {
                this.contentEditable = 'false';
                const newTitle = this.textContent.trim();
                if (!newTitle || !currentProjectId || currentProjectId === '__new__') return;
                try {
                    await fetch(`/api/projects/${encodeURIComponent(currentProjectId)}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title: newTitle })
                    });
                    refreshProjects();
                } catch (e) {
                    console.error('ä¿å­˜æ ‡é¢˜å¤±è´¥', e);
                }
            });

            titleEl.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.blur();
                }
                if (e.key === 'Escape') {
                    e.preventDefault();
                    this.contentEditable = 'false';
                    // æ¢å¤åŸæ ‡é¢˜
                    loadProject(currentProjectId);
                }
            });
        })();

        // â”€â”€ è‡ªåŠ¨è°ƒæ•´ textarea é«˜åº¦ â”€â”€
        const textarea = document.getElementById('chatInput');
        textarea.addEventListener('input', function() {
            autoResizeTextarea(this);
        });
        function autoResizeTextarea(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';
        }

        // â”€â”€ Enter æäº¤ URL â”€â”€
        document.getElementById('urlInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                startProcess();
            }
        });

        // â”€â”€ å¯åŠ¨æ—¶åŠ è½½é¡¹ç›®åˆ—è¡¨ & hash è·³è½¬ â”€â”€
        window.addEventListener('load', async () => {
            loadLayoutState();
            setupLayoutControls();
            applyLayoutState();

            const savedTheme = localStorage.getItem('zimu_theme') || 'happy';
            const sel = document.getElementById('themeSelect');
            if (sel) sel.value = savedTheme;
            applyTheme(savedTheme);
            await loadTags();
            await refreshProjects();
            const hashId = (location.hash || '').replace('#', '').trim();
            if (hashId) {
                loadProject(hashId);
            }
        });
    </script>
</body>
</html>
